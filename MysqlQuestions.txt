1. Your CEO asks you to find out some information for the next investment round report - they want to know 3 the most popular tour types (the type name and the corresponding number of active tours). Type popularity is measured by the number of active tours. Please write a database query to extract the requested information.

answer:
SELECT type.name, q3.countTour FROM type,(SELECT COUNT(tour_type.tour_id) as countTour,tour_type.type_id FROM tour_type WHERE tour_type.type_id IN (SELECT q2.type_id FROM (SELECT tour_type.type_id, COUNT(tour_type.type_id) FROM tour_type WHERE tour_type.tour_id IN (SELECT tour.id FROM tour WHERE tour.operator_id = (SELECT q1.operator_id FROM (SELECT tour.operator_id, COUNT(tour.operator_id) FROM tour WHERE tour.active = 1 AND tour.operator_id in (SELECT operator.id FROM operator WHERE operator.active = 1) GROUP BY tour.operator_id ORDER BY COUNT(tour.operator_id) DESC LIMIT 1) q1) AND tour.active=1) GROUP BY tour_type.type_id ORDER BY COUNT(tour_type.type_id) DESC LIMIT 3) q2) GROUP BY tour_type.type_id ORDER BY COUNT(tour_type.tour_id) DESC) q3 WHERE type.id=q3.type_id ORDER BY q3.countTour DESC

2. Marketing department wants to run a sale campaign, and they want to know for each active operator how many active departures in total they have in a next calendar month (for example, if today is July 16th, they care about departures in August); so the output format should contain the name of the operator and the number of active departures from the next month. Please write a database query, which will work any time, not only today or this month.

answer:
SELECT q2.name, COUNT(q2.name) FROM (SELECT tour_departure.tour_id FROM tour_departure WHERE tour_departure.tour_id IN (SELECT tour.id FROM tour WHERE tour.operator_id IN (SELECT operator.id FROM operator WHERE operator.active=1) AND tour.active=1) AND tour_departure.active=1 AND tour_departure.date >= NOW() AND tour_departure.date < (SELECT DATE_ADD(NOW(),INTERVAL 1 MONTH)) GROUP BY tour_departure.tour_id) q1, (SELECT tour.id, tour.operator_id, operator.name FROM tour, operator WHERE tour.operator_id IN (SELECT operator.id FROM operator WHERE operator.active=1) AND tour.active=1 AND tour.operator_id = operator.id) q2 WHERE q1.tour_id = q2.id GROUP BY q2.name

3. You had a long brainstorming session between your tech team, marketing department and SEO specialists about how to increase the number of sales in the next months. You decided to offer a 20% discount on some tours, which satisfy the following requirements: a) tour should belong only to one type (for example, tour #105 belongs only to culinary category); b) tour should have at least 7 active departures; c) tour price (which is the minimal price among all active departures) should be at least 3000 euros. Please write a request to get the tour ID, tour name and the tour price.

answer:
SELECT q1.tour_id, tour.name, q1.minPrice FROM (SELECT COUNT(tour_departure.tour_id) countActive, tour_departure.tour_id, MIN(tour_departure.price) minPrice FROM tour_departure WHERE tour_departure.tour_id IN (SELECT tour_type.tour_id FROM tour_type GROUP BY tour_type.tour_id HAVING COUNT(tour_type.tour_id) = 1) AND tour_departure.active=1 AND tour_departure.price >= 3000 GROUP BY tour_departure.tour_id) q1, tour WHERE q1.countActive > 6 AND tour.id = q1.tour_id